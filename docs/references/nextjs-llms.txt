# Next.js Reference — For LLMs

> Compact reference for AI agents working on the Resume Maker frontend.

---

## Stack

- Next.js 14+ (App Router)
- TypeScript (strict)
- CSS Modules
- React Context + `useReducer` for resume editor state
- Vitest for unit/route tests

---

## Current App Structure

```text
src/app/
├── layout.tsx
├── page.tsx
├── globals.css
├── editor/page.tsx
└── api/
    ├── auth/
    │   ├── google/start/route.ts
    │   ├── callback/route.ts
    │   ├── session/route.ts
    │   └── logout/route.ts
    └── v1/resumes/
        ├── route.ts
        ├── [id]/route.ts
        └── generate-pdf/route.ts

src/components/
├── editor/
├── preview/
└── home/

src/hooks/
└── use-auth-session.ts

src/lib/
├── api.ts
├── auth-api.ts
├── resume-context.tsx
├── types.ts
└── validation.ts

src/server/
├── auth-user.ts
├── http-cookies.ts
├── json-error.ts
├── pdf-proxy.ts
├── pdf-service-auth.ts
└── supabase-server.ts
```

---

## Architectural Rules

1. Browser never talks directly to Supabase.
2. Browser calls Next.js BFF routes under `/api/*`.
3. Protected routes validate `sb-access-token` using Supabase `auth.getUser()`.
4. PDF generation uses Next.js proxy -> Go service (HMAC signed).

---

## Auth Flow

1. `GET /api/auth/session` checks current auth state
2. Unauthenticated users start OAuth with `GET /api/auth/google/start`
3. OAuth callback: `GET /api/auth/callback?code=...`
4. Callback sets httpOnly cookies:
   - `sb-access-token`
   - `sb-refresh-token`
5. Logout via `POST /api/auth/logout`

---

## Data + PDF Flow

### Resume CRUD

- `GET /api/v1/resumes`
- `POST /api/v1/resumes`
- `GET /api/v1/resumes/:id`
- `PATCH /api/v1/resumes/:id`
- `DELETE /api/v1/resumes/:id`

### PDF

- Client calls `POST /api/v1/resumes/generate-pdf`
- Next.js forwards to Go `POST /api/v1/resumes/generate-pdf`
- Next.js signs request with service HMAC headers
- Response is PDF bytes (`application/pdf`)

---

## API Client Pattern (Current)

```typescript
// src/lib/api.ts
const apiUrl = process.env.NEXT_PUBLIC_API_URL ?? '';
const baseURL = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;

const response = await fetch(`${baseURL}/api/v1/resumes/generate-pdf`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(payload),
});
```

Notes:

- No Bearer token header is used in browser fetches.
- Auth is cookie-based.

---

## Environment Variables (Frontend)

| Variable | Purpose | Default |
|----------|---------|---------|
| `NEXT_PUBLIC_API_URL` | Optional API base override for browser requests | same-origin |
| `NEXT_PUBLIC_APP_URL` | Public app URL for OAuth redirect construction | request origin |
| `SUPABASE_URL` | Supabase project URL (server-side use) | none |
| `SUPABASE_ANON_KEY` | Supabase anon key (server-side use) | none |
| `GO_PDF_SERVICE_URL` | Go PDF endpoint URL used by proxy | `http://localhost:8080/api/v1/resumes/generate-pdf` |
| `GO_PDF_SERVICE_HMAC_SECRET` | Shared secret for request signing | none |
| `GO_PDF_SERVICE_ID` | Service identifier header value | `nextjs-api` |

---

## Editing Guardrails

- Keep types in `src/lib/types.ts`
- Keep server-only logic in `src/server/*`
- Reuse `jsonError()` for consistent error payloads
- Preserve existing API response shapes to avoid frontend regressions
